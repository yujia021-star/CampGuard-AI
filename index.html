<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampGuard Pro AI - Ver 3.5</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card: rgba(15, 23, 42, 0.9);
            --accent: #38bdf8;
            --danger: #dc2626;   /* 鮮やかな赤 */
            --warning: #f59e0b;  /* 警告のオレンジ */
            --success: #10b981;  /* 安全の緑 */
            --text: #f1f5f9;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            background-color: var(--bg) !important;
            color: var(--text);
            transition: background-color 1.2s ease-in-out !important;
        }
        
        /* 状態別背景（不気味さを抑えた配色） */
        body.safe-bg { background-color: #064e3b !important; }    /* 森の緑 */
        body.warning-bg { background-color: #431407 !important; } /* 警告の茶・橙系 */
        body.danger-bg { background-color: #7f1d1d !important; }  /* 危険の深い赤 */

        .weather-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999 !important; 
        }

        .wind-line {
            position: absolute; 
            background: rgba(255,255,255,0.4) !important;
            height: 1px; width: 120px;
            animation: windMove linear infinite;
            display: none;
        }

        @keyframes windMove {
            0% { transform: translateX(-100vw); opacity: 0; }
            50% { opacity: 0.5; }
            100% { transform: translateX(100vw); opacity: 0; }
        }

        .container { width: 100%; max-width: 450px; padding: 25px; box-sizing: border-box; z-index: 10; position: relative; }
        .header h1 { font-size: 1.8rem; margin: 0; background: linear-gradient(to right, #38bdf8, #818cf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .search-box { position: relative; margin: 20px 0 30px 0; }
        input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #334155; background: var(--card); color: white; box-sizing: border-box; font-size: 1rem; outline: none; }
        button { position: absolute; right: 8px; top: 8px; padding: 8px 20px; border-radius: 8px; border: none; background: var(--accent); color: #0f172a; font-weight: bold; cursor: pointer; }

        .gauge-container { 
            background: var(--card); border-radius: 24px; padding: 30px 20px; text-align: center; 
            backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 25px; position: relative;
        }
        .chart-box { height: 200px; width: 100%; }
        .score-label { position: absolute; bottom: 45px; left: 50%; transform: translateX(-50%); width: 100%;}
        .score-number { font-size: 4rem; font-weight: 800; line-height: 1; }
        .location-tag { font-size: 0.8rem; color: var(--accent); margin-top: 10px; display: block; font-weight: bold; padding: 0 20px; }

        .result-card { background: var(--card); border-radius: 24px; padding: 25px; border: 1px solid rgba(255,255,255,0.1); display: none; }
        .badge { padding: 5px 15px; border-radius: 50px; font-size: 0.75rem; font-weight: bold; margin-bottom: 15px; display: inline-block; }
        .badge.danger { background: var(--danger); color: white; }
        .badge.warning { background: var(--warning); color: #0f172a; }
        .badge.safe { background: var(--success); color: white; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .info-item { text-align: center; }
        .info-label { font-size: 0.7rem; color: #94a3b8; display: block; }
        .info-value { font-size: 0.9rem; font-weight: bold; }
    </style>
</head>
<body id="mainBody">

<div id="windOverlay" class="weather-overlay"></div>

<div class="container">
    <div class="header">
        <h1>CampGuard Pro</h1>
        <p style="color: #94a3b8; font-size: 0.85rem;">Evolution Ver. 3.5</p>
    </div>

    <div class="search-box">
        <input type="text" id="locationInput" placeholder="地名を入力" value="喜多方市">
        <button onclick="diagnose()">診断</button>
    </div>

    <div class="gauge-container">
        <div class="chart-box"><canvas id="gaugeChart"></canvas></div>
        <div class="score-label">
            <span id="scoreValue" class="score-number">--</span>
            <span id="targetName" class="location-tag">Ready</span>
        </div>
    </div>

    <div id="resultArea" class="result-card">
        <div id="statusBadge" class="badge">--</div>
        <div id="message" style="font-size: 1.1rem; font-weight: 500; line-height: 1.4;"></div>
        
        <div class="info-grid">
            <div class="info-item"><span class="info-label">WIND</span><span id="windVal" class="info-value">--</span></div>
            <div class="info-item"><span class="info-label">RAIN</span><span id="rainVal" class="info-value">--</span></div>
            <div class="info-item"><span class="info-label">ALERTS</span><span id="alertVal" class="info-value">--</span></div>
        </div>
    </div>
</div>

<script>
    let myChart;
    const gasUrl = "https://script.google.com/macros/s/AKfycbyqDTFt6HyyWfDLJJTkB2hQfSik9oJJfmIJBsRZ4U_kacbxYjlE2lB759s7scGMhaHx/exec";

    function initChart() {
        const ctx = document.getElementById('gaugeChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [1, 1, 1],
                    backgroundColor: ['rgba(255,255,255,0.1)', 'rgba(255,255,255,0.1)', 'rgba(255,255,255,0.1)'],
                    borderWidth: 0, circumference: 180, rotation: 270,
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '85%', plugins: { legend: { display: false } } }
        });
        createWindLines();
    }

    function createWindLines() {
        const overlay = document.getElementById('windOverlay');
        overlay.innerHTML = ''; 
        for(let i=0; i<30; i++) {
            const line = document.createElement('div');
            line.className = 'wind-line';
            line.style.top = Math.random() * 100 + 'vh';
            line.style.animationDuration = (Math.random() * 0.5 + 0.2) + 's';
            line.style.animationDelay = Math.random() * 2 + 's';
            overlay.appendChild(line);
        }
    }

    async function diagnose() {
        const loc = document.getElementById('locationInput').value;
        const targetDisp = document.getElementById('targetName');
        targetDisp.innerText = "Analyzing...";
        
        try {
            const res = await fetch(`${gasUrl}?place=${encodeURIComponent(loc)}`);
            const data = await res.json();
            
            document.getElementById('scoreValue').innerText = data.score;
            targetDisp.innerText = data.locationName;
            document.getElementById('windVal').innerText = data.windSpeed + " m/s";
            document.getElementById('rainVal').innerText = data.rain + " mm";
            document.getElementById('alertVal').innerText = data.snsReports;
            
            updateUI(data.score, parseFloat(data.windSpeed), data.snsReports);
            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('message').innerText = data.advice;
            
        } catch (e) { targetDisp.innerText = "Error: Connection Failed"; }
    }

    function updateUI(score, wind, alerts) {
        const body = document.getElementById('mainBody');
        const badge = document.getElementById('statusBadge');
        const lines = document.querySelectorAll('.wind-line');
        const colors = myChart.data.datasets[0].backgroundColor;
        
        body.classList.remove('safe-bg', 'warning-bg', 'danger-bg');
        lines.forEach(l => l.style.display = (wind >= 5) ? 'block' : 'none');
        
        if (score >= 75 || alerts > 0) {
            badge.className = "badge danger";
            badge.innerText = alerts > 0 ? "SURROUNDING RISK" : "WEATHER DANGER";
            body.classList.add('danger-bg');
            colors.fill('rgba(255,255,255,0.1)'); colors[2] = '#dc2626';
        } else if (score >= 40) {
            badge.className = "badge warning"; badge.innerText = "CAUTION";
            body.classList.add('warning-bg');
            colors.fill('rgba(255,255,255,0.1)'); colors[1] = '#f59e0b';
        } else {
            badge.className = "badge safe"; badge.innerText = "STABLE";
            body.classList.add('safe-bg');
            colors.fill('rgba(255,255,255,0.1)'); colors[0] = '#10b981';
        }
        myChart.update();
    }
    window.onload = initChart;
</script>
</body>
</html>
