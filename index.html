<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CampGuard Expert v12</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root { --bg: #0b0f1a; --card: #1e293b; --accent: #38bdf8; --text: #f1f5f9; --warning: #f59e0b; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; -webkit-font-smoothing: antialiased; }
        .container { max-width: 480px; margin: 0 auto; padding: 15px; }
        .page { display: none; animation: fadeIn 0.3s ease; } .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .main-card { background: var(--card); border-radius: 28px; padding: 20px; text-align: center; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .gauge-outer { position: relative; height: 160px; margin-bottom: 10px; }
        .score-display { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; }
        .score-num { font-size: 5rem; font-weight: 900; line-height: 1; letter-spacing: -2px; }
        .search-box { display: flex; gap: 8px; margin-bottom: 20px; }
        input, textarea { flex: 1; padding: 14px; border-radius: 14px; border: 1px solid #334155; background: #0f172a; color: white; width: 100%; box-sizing: border-box; font-size: 16px; outline: none; }
        input:focus { border-color: var(--accent); }
        .btn-diag { background: var(--accent); color: #0f172a; border: none; border-radius: 14px; padding: 0 24px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-diag:active { transform: scale(0.95); }
        .tag { font-size: 0.75rem; color: var(--accent); font-weight: bold; text-align: left; margin-top: 20px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .bubble { background: rgba(255,255,255,0.04); padding: 16px; border-radius: 20px; font-size: 0.9rem; margin-bottom: 12px; border-left: 4px solid var(--accent); text-align: left; line-height: 1.5; }
        .timeline { display: flex; gap: 12px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; -ms-overflow-style: none; }
        .timeline::-webkit-scrollbar { display: none; }
        .t-item { background: #334155; padding: 12px 8px; border-radius: 16px; min-width: 65px; text-align: center; flex-shrink: 0; }
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 12px 0 25px 0; border-top: 1px solid rgba(255,255,255,0.1); z-index: 1000; }
        .nav-item { cursor: pointer; font-size: 0.7rem; opacity: 0.4; text-align: center; color: white; transition: 0.3s; }
        .nav-item.active { opacity: 1; color: var(--accent); }
        .nav-item span { font-size: 1.4rem; display: block; margin-bottom: 4px; }
        .loading { position: fixed; inset: 0; background: rgba(11, 15, 26, 0.9); display: none; align-items: center; justify-content: center; z-index: 2000; font-weight: bold; }
        .detail-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 0.65rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 18px; margin-top: 18px; }
        .detail-grid b { font-size: 1rem; display: block; color: white; margin-bottom: 2px; }
    </style>
</head>
<body>

<div id="loader" class="loading">ç’°å¢ƒã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆä¸­...</div>

<div class="container">
    <div id="pageDiag" class="page active">
        <h2 style="text-align:center; letter-spacing: 2px;">CAMPGUARD <span style="color:var(--accent)">EXPERT</span></h2>
        <div class="search-box">
            <input type="text" id="loc" placeholder="ã‚­ãƒ£ãƒ³ãƒ—å ´åã‚’å…¥åŠ›" value="å°å€‰æ©‹">
            <button class="btn-diag" onclick="diagnose()">è¨ºæ–­</button>
        </div>
        <div id="resultArea" style="display:none;">
            <div class="main-card">
                <div id="resLoc" style="font-size:0.9rem; color:var(--accent); font-weight: bold; margin-bottom:12px;"></div>
                <div class="gauge-outer"><canvas id="gaugeChart"></canvas><div class="score-display"><div id="resScore" class="score-num">0</div></div></div>
                <div id="insightContainer"></div>
            </div>
            <div class="tag">ğŸ•’ äºˆå ±ï¼ˆå½“æ—¥ã€œç¿Œæ—¥ï¼‰</div>
            <div id="resTimeline" class="timeline"></div>
        </div>
    </div>

    <div id="pageDiary" class="page">
        <h2 style="text-align:center;">Diary</h2>
        <div class="main-card" style="text-align:left;">
            <div class="tag" style="margin-top:0;">ğŸ“… ã‚­ãƒ£ãƒ³ãƒ—å®Ÿæ–½æ—¥</div>
            <input type="date" id="dDate" style="margin-bottom:15px;">
            <div class="tag">ğŸ“ ã‚­ãƒ£ãƒ³ãƒ—å ´</div>
            <input type="text" id="dPlace" placeholder="ä¾‹ï¼šå°å€‰æ©‹ã‚­ãƒ£ãƒ³ãƒ—å ´">
            <div class="tag">ğŸ·ï¸ ã‚¿ã‚¤ãƒˆãƒ«</div>
            <input type="text" id="dTopic" placeholder="ä¾‹ï¼šå¼·é¢¨æ™‚ã®å¯¾ç­–ã«ã¤ã„ã¦">
            <div class="tag">âœï¸ ã¿ã‚“ãªã«å…±æœ‰ã™ã‚‹çŸ¥æµ</div>
            <textarea id="dContent" placeholder="ã€Œå¤œã®éš™é–“é¢¨ãŒã™ã”ã‹ã£ãŸã€ã€Œãƒšã‚°ã¯30cmãŒå¿…è¦ã€ãªã©ã€æœªæ¥ã®èª°ã‹ã®å½¹ã«ç«‹ã¤æƒ…å ±ã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚" style="height:120px;"></textarea>
            <button onclick="saveDiary()" style="width:100%; padding:16px; margin-top:20px; background:var(--accent); border:none; border-radius:14px; font-weight:bold; color:#0f172a; font-size: 1rem;">æ—¥è¨˜ã‚’ä¿å­˜ã—ã¦çŸ¥æµã‚’å…±æœ‰</button>
        </div>
    </div>

    <div id="pageHistory" class="page">
        <h2 style="text-align:center;">Activity Log</h2>
        <div id="historyList"></div>
    </div>
</div>

<div class="nav">
    <div class="nav-item active" onclick="switchPage('pageDiag', this)"><span>ğŸ </span>è¨ºæ–­</div>
    <div class="nav-item" onclick="switchPage('pageDiary', this)"><span>âœï¸</span>æ—¥è¨˜</div>
    <div class="nav-item" onclick="loadHistory(this)"><span>ğŸ“š</span>å±¥æ­´</div>
</div>

<script>
    // ã€é‡è¦ã€‘ã“ã“ã«æœ€æ–°ã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
    const gasUrl = "https://script.google.com/macros/s/AKfycbyqDTFt6HyyWfDLJJTkB2hQfSik9oJJfmIJBsRZ4U_kacbxYjlE2lB759s7scGMhaHx/exec"; 
    let myChart;

    function switchPage(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        window.scrollTo(0, 0);
    }

    async function diagnose() {
        document.getElementById('loader').style.display = 'flex';
        try {
            const res = await fetch(`${gasUrl}?mode=diagnose&place=${encodeURIComponent(document.getElementById('loc').value)}`);
            const data = await res.json();
            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('resLoc').innerText = data.locationName;
            document.getElementById('resScore').innerText = data.score;
            updateGauge(data.score);

            let html = `
                <div style="font-size:0.75rem; opacity:0.6; margin-bottom:10px;">${data.scoreReason}</div>
                <div style="background:rgba(56, 189, 248, 0.1); padding:16px; border-radius:16px; margin:12px 0; font-size:0.95rem; font-weight:bold; border:1px solid rgba(56,189,248,0.3); color:#fff;">
                    ${data.alertTitle}
                </div>
                <div style="text-align:left; margin-top:20px;">
                    <div class="tag">ğŸ›¡ï¸ æ¨å¥¨è£…å‚™ãƒã‚§ãƒƒã‚¯</div>
                    <div class="bubble">${data.checkList.map(item => `<div><span style="color:#10b981; margin-right:8px;">âœ…</span>${item}</div>`).join('')}</div>
                </div>
                <div class="detail-grid">
                    <div>æœ€å¤§é¢¨é€Ÿ<br><b>${data.maxWind}</b>m/s</div><div>æœ€é«˜æ°—æ¸©<br><b>${data.maxTemp}</b>â„ƒ</div><div>æœ€ä½æ°—æ¸©<br><b>${data.minTemp}</b>â„ƒ</div><div>æœ€å¤§é›¨é‡<br><b>${data.maxRain}</b>mm</div>
                </div>
            `;

            // ã€æ–°æ©Ÿèƒ½ã€‘ä»–è€…ã®çŸ¥æµã‚’è¡¨ç¤ºã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            if(data.localInsights && data.localInsights.length > 0) {
                html += `<div class="tag" style="margin-top:28px; color:var(--warning);">ğŸ’¡ å…ˆäººãŸã¡ã®çŸ¥æµï¼ˆæ—¥è¨˜ã‚ˆã‚Šï¼‰</div>`;
                data.localInsights.forEach(i => {
                    html += `
                        <div class="bubble" style="border-left-color:var(--warning); background:rgba(245,158,11,0.06);">
                            <div style="font-size:0.65rem; opacity:0.5; margin-bottom:4px;">ğŸ“… ${i.date} ã®è¨˜éŒ²</div>
                            <div style="font-weight:bold; color:var(--warning); margin-bottom:4px;">${i.topic}</div>
                            <div style="font-size:0.85rem; opacity:0.9;">${i.content}</div>
                        </div>`;
                });
            }

            document.getElementById('insightContainer').innerHTML = html;
            document.getElementById('resTimeline').innerHTML = data.timeline.map(t => `
                <div class="t-item"><div style="font-size:0.65rem; color:var(--accent); font-weight:bold;">${t.time}</div><img src="https://openweathermap.org/img/wn/${t.icon}.png" width="35"><div>${t.temp}â„ƒ</div></div>
            `).join('');
        } catch(e) { alert("è¨ºæ–­å¤±æ•—ã€‚é€šä¿¡ç’°å¢ƒã¾ãŸã¯URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); }
        document.getElementById('loader').style.display = 'none';
    }

    function updateGauge(score) {
        const ctx = document.getElementById('gaugeChart').getContext('2d');
        const color = score >= 70 ? '#ef4444' : (score >= 40 ? '#f59e0b' : '#10b981');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, { type: 'doughnut', data: { datasets: [{ data: [score, 100 - score], backgroundColor: [color, 'rgba(255,255,255,0.05)'], borderWidth: 0, circumference: 180, rotation: 270, cutout: '90%' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } } });
    }

    async function saveDiary() {
        const date = document.getElementById('dDate').value;
        const place = document.getElementById('dPlace').value;
        const topic = document.getElementById('dTopic').value;
        const content = document.getElementById('dContent').value;
        if(!date || !place || !topic || !content) return alert("ã™ã¹ã¦ã®é …ç›®ã‚’åŸ‹ã‚ã¦ãã ã•ã„ã€‚");
        
        document.getElementById('loader').style.display = 'flex';
        try {
            const url = `${gasUrl}?mode=postDiary&place=${encodeURIComponent(place)}&topic=${encodeURIComponent(topic)}&content=${encodeURIComponent(content)}&campDate=${encodeURIComponent(date)}`;
            await fetch(url, {mode: 'no-cors'});
            alert("æ—¥è¨˜ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ã‚ãªãŸã®çŸ¥æµãŒå…±æœ‰ã•ã‚Œã¾ã—ãŸï¼");
            document.getElementById('dTopic').value = ""; document.getElementById('dContent').value = "";
            switchPage('pageDiag', document.querySelector('.nav-item'));
        } catch(e) { alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
        document.getElementById('loader').style.display = 'none';
    }

    async function loadHistory(el) {
        switchPage('pageHistory', el);
        const list = document.getElementById('historyList');
        list.innerHTML = `<div style="text-align:center; padding:20px; opacity:0.5;">èª­ã¿è¾¼ã¿ä¸­...</div>`;
        try {
            const res = await fetch(`${gasUrl}?mode=getDiaries`);
            const data = await res.json();
            list.innerHTML = data.length ? data.map(d => `
                <div class="main-card" style="text-align:left;">
                    <div style="color:var(--accent); font-size:0.75rem; font-weight:bold; margin-bottom:8px;">ğŸ“… ${d.campDate} @${d.place}</div>
                    <div style="font-weight:bold; font-size:1.1rem; margin-bottom:8px;">${d.topic}</div>
                    <div style="opacity:0.85; font-size:0.95rem; line-height:1.6; background:rgba(255,255,255,0.03); padding:12px; border-radius:12px;">${d.content}</div>
                </div>
            `).join('') : `<div style="text-align:center; padding:40px; opacity:0.5;">ã¾ã æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        } catch(e) { alert("å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
    }
</script>
</body>
</html>
