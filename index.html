<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampGuard Expert v11.1</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root { --bg: #0b0f1a; --card: #1e293b; --accent: #38bdf8; --danger: #ef4444; --warning: #f59e0b; --text: #f1f5f9; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        .container { max-width: 480px; margin: 0 auto; padding: 15px; }
        .page { display: none; }
        .active { display: block; }
        
        /* „É°„Ç§„É≥„Ç´„Éº„Éâ & „É°„Éº„Çø„Éº */
        .main-card { background: var(--card); border-radius: 28px; padding: 20px; text-align: center; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        .gauge-container { position: relative; height: 180px; margin-bottom: -40px; }
        .score-display { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .score-num { font-size: 4rem; font-weight: 900; line-height: 1; }
        
        /* Ê§úÁ¥¢„Éê„Éº */
        .search-box { display: flex; gap: 8px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: white; }
        .btn-diag { background: var(--accent); color: #0f172a; border: none; border-radius: 12px; padding: 0 20px; font-weight: bold; cursor: pointer; }

        /* „Çø„Ç§„É†„É©„Ç§„É≥ */
        .timeline { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; }
        .t-item { background: #334155; padding: 10px; border-radius: 12px; min-width: 60px; text-align: center; flex: 0 0 auto; }

        /* „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; display: flex; justify-content: space-around; padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .nav-item { cursor: pointer; font-size: 0.8rem; opacity: 0.6; text-align: center; }
        .nav-item.active { opacity: 1; color: var(--accent); }
        
        .loading { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 2000; }
    </style>
</head>
<body>

<div id="loader" class="loading">Ëß£Êûê‰∏≠...</div>

<div class="container">
    <div id="pageDiag" class="page active">
        <h2 style="text-align:center;">CampGuard <span style="color:var(--accent)">Expert</span></h2>
        <div class="search-box">
            <input type="text" id="loc" value="Èµ†Ê≤º">
            <button class="btn-diag" onclick="diagnose()">Ë®∫Êñ≠</button>
        </div>

        <div id="resultArea" style="display:none;">
            <div class="main-card">
                <div id="resLoc" style="font-size:0.8rem; color:var(--accent); margin-bottom: 10px;"></div>
                <div class="gauge-container">
                    <canvas id="gaugeChart"></canvas>
                    <div class="score-display">
                        <div id="resScore" class="score-num">--</div>
                    </div>
                </div>
                
                <div id="resAdv" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; text-align:left; font-size:0.9rem; margin:15px 0; border-left: 4px solid var(--accent);"></div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; font-size:0.75rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
                    <div>ÊúÄÂ§ßÈ¢®ÈÄü<br><b id="resWind" style="font-size:1rem;"></b></div>
                    <div>ÊúÄÈ´òÊ∞óÊ∏©<br><b id="resMaxT" style="font-size:1rem;"></b></div>
                    <div>ÊúÄ‰ΩéÊ∞óÊ∏©<br><b id="resMinT" style="font-size:1rem;"></b></div>
                </div>
            </div>

            <div id="resTimeline" class="timeline"></div>

            <div class="main-card" style="text-align:left; font-size:0.85rem;">
                <div style="font-weight:bold; color:var(--accent); margin-bottom:10px;">üõ°Ô∏è Êé®Â•®Ë£ÖÂÇô„ÉÅ„Çß„ÉÉ„ÇØ</div>
                <div id="resGear"></div>
            </div>
        </div>
    </div>

    <div id="pageDiary" class="page">
        <h2 style="text-align:center;">Camp Diary</h2>
        <div class="main-card">
            <input type="text" id="dPlace" placeholder="„Ç≠„É£„É≥„ÉóÂ†¥Âêç" style="width:100%; box-sizing:border-box; margin-bottom:10px; padding:12px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:white;">
            <input type="text" id="dTopic" placeholder="„Çø„Ç§„Éà„É´" style="width:100%; box-sizing:border-box; margin-bottom:10px; padding:12px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:white;">
            <textarea id="dContent" placeholder="ÂÜÖÂÆπ" style="width:100%; box-sizing:border-box; margin-bottom:10px; padding:12px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:white; height:100px;"></textarea>
            <button onclick="saveDiary()" style="width:100%; padding:15px; border-radius:12px; background:var(--accent); border:none; font-weight:bold;">Êó•Ë®ò„Çí‰øùÂ≠ò</button>
        </div>
    </div>

    <div id="pageHistory" class="page">
        <h2 style="text-align:center;">History</h2>
        <div id="historyList"></div>
    </div>
</div>

<div class="nav">
    <div class="nav-item active" onclick="switchPage('pageDiag', this)">üè†<br>Ë®∫Êñ≠</div>
    <div class="nav-item" onclick="switchPage('pageDiary', this)">‚úçÔ∏è<br>Êó•Ë®ò</div>
    <div class="nav-item" onclick="loadHistory(this)">üìö<br>Â±•Ê≠¥</div>
</div>

<script>
    const gasUrl = "https://script.google.com/macros/s/AKfycbyqDTFt6HyyWfDLJJTkB2hQfSik9oJJfmIJBsRZ4U_kacbxYjlE2lB759s7scGMhaHx/exec";
    let myChart;

    function switchPage(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    async function diagnose() {
        const loader = document.getElementById('loader');
        loader.style.display = 'flex';
        const place = document.getElementById('loc').value;
        
        try {
            const res = await fetch(`${gasUrl}?mode=diagnose&place=${encodeURIComponent(place)}`);
            const data = await res.json();

            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('resLoc').innerText = data.locationName;
            document.getElementById('resScore').innerText = data.score;
            document.getElementById('resAdv').innerText = data.recommendation;
            document.getElementById('resWind').innerText = data.maxWind + "m/s";
            document.getElementById('resMaxT').innerText = data.maxTemp + "‚ÑÉ";
            document.getElementById('resMinT').innerText = data.minTemp + "‚ÑÉ";

            // „É°„Éº„Çø„ÉºÊèèÁîª
            updateGauge(data.score);

            // „ÇÆ„Ç¢
            let gearHtml = "";
            if(data.maxWind > 5) gearHtml += "‚úÖ 30cm‰ª•‰∏ä„ÅÆÈçõÈÄ†„Éö„Ç∞<br>";
            if(data.minTemp < 10) gearHtml += "‚úÖ ÂÜ¨Áî®„Ç∑„É•„É©„Éï„Éª„Çπ„Éà„Éº„Éñ<br>";
            document.getElementById('resGear').innerHTML = gearHtml || "Ê®ôÊ∫ñË£ÖÂÇô„ÅßOK";

            // „Çø„Ç§„É†„É©„Ç§„É≥
            document.getElementById('resTimeline').innerHTML = data.timeline.map(t => `
                <div class="t-item">
                    <div style="font-size:0.6rem;">${t.time}</div>
                    <img src="https://openweathermap.org/img/wn/${t.icon}.png" width="25">
                    <div style="font-weight:bold;">${t.temp}‚ÑÉ</div>
                </div>
            `).join('');

        } catch(e) { alert("Ë®∫Êñ≠Â§±Êïó"); }
        loader.style.display = 'none';
    }

    function updateGauge(score) {
        const ctx = document.getElementById('gaugeChart').getContext('2d');
        const color = score >= 70 ? '#ef4444' : (score >= 40 ? '#f59e0b' : '#10b981');
        
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: { datasets: [{ data: [score, 100 - score], backgroundColor: [color, '#334155'], borderWidth: 0, circumference: 180, rotation: 270, cutout: '85%' }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } }, animation: { duration: 1500 } }
        });
    }

    async function saveDiary() {
        const place = document.getElementById('dPlace').value;
        const topic = document.getElementById('dTopic').value;
        const content = document.getElementById('dContent').value;
        await fetch(`${gasUrl}?mode=postDiary&place=${encodeURIComponent(place)}&topic=${encodeURIComponent(topic)}&content=${encodeURIComponent(content)}`);
        alert("Êó•Ë®ò„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ");
    }

    async function loadHistory(el) {
        switchPage('pageHistory', el);
        const res = await fetch(`${gasUrl}?mode=getDiaries`);
        const data = await res.json();
        document.getElementById('historyList').innerHTML = data.map(d => `
            <div class="main-card" style="text-align:left; font-size:0.85rem;">
                <div style="color:var(--accent); font-size:0.7rem;">${new Date(d.date).toLocaleDateString()} @${d.place}</div>
                <div style="font-weight:bold; margin:5px 0;">${d.topic}</div>
                <div>${d.content}</div>
            </div>
        `).join('');
    }
</script>
</body>
</html>
